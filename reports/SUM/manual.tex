% !TEX root = MAIN.tex

\chapter{MASS - Operations Manual}

\section{Set-up and Initialization}
\label{sec:install}

\MASS depends on LLVM for source code mutation. For this reason, a full LLVM-3.8.1 installation is necessary preceding the installation of the \texttt{SRCMutation} component. For this procedure, a Bash script is provided.

The following shell command installs the corresponding dependencies and the \texttt{SRCMutation} component.

\begin{lstlisting}[language=bash]
  $ ./llvm-build.sh
\end{lstlisting}

\subsection{Dependencies}

%\TODO{should we add the LLVM version?}
%\OSCAR{llvm is installed automatically in the previous step, only clang3.8 is necessary}

\begin{itemize}
	\item Linux packages: \texttt{clang 3.8}, \texttt{r-base}, \texttt{jq}, \texttt{Python 3.7} or higher
	\item R packages: \texttt{binom}
	\item Python packages: \texttt{numpy}, \texttt{scipy}
\end{itemize}


\section{Getting started}

\subsection{Initialization of the MASS workspace}

% \DONE{I think "shall" should be simply removed, "\MASS creates" "are stored".}

\MASS creates a workspace folder where all the steps from the methodology are stored.

An installation Bash script is provided for the creation of this workspace, the script can be found on \texttt{\$FAQAS/MASS/FAQAS-Setup/install.sh}

To use the installation script the shell variable \texttt{INSTALL\_DIR} has to be set:

\begin{lstlisting}[language=bash]
  $ export INSTALL_DIR=/opt/DIRECTORY
\end{lstlisting}

%\DONE{the meaning of the ollowing is not clear. Add an example.}
If the \texttt{INSTALL\_DIR} directory must be binded inside a container. In addition, also the shell variable \texttt{EXECUTION\_DIR} has to be set. This step is optional.

For instance, \MASS has been installed on \texttt{/opt/MASS\_WORKSPACE} (i.e., the \texttt{INSTALL\_DIR}), and \MASS will be executed inside a container, but on a different directory such as \\\texttt{/home/user/MASS\_WORKSPACE} (i.e., the \texttt{EXECUTION\_DIR}). The use of both environment variables enable this differentiation.


After setting the corresponding environment variables, the following commands are necessary to create the \MASS workspace folder:

\begin{lstlisting}[language=bash]
  $ cd $FAQAS/MASS/FAQAS-Setup
  $ ./install.sh
\end{lstlisting}

Once the installation folder has been created, the folder shall contain the following structure and files:

\begin{itemize}
	\item \texttt{Launcher.sh}: \MASS single launcher; the script executes all the steps of the methodology in one command.
	\item \texttt{mass\_conf.sh}: \MASS configuration file; the file has to be configured before being able to execute \MASS.
	\item \texttt{mutation\_additional\_functions.sh}: Bash script that must be filled by the application engineer before executing \MASS.
	\item \texttt{MASS\_STEPS\_LAUNCHERS/}: folder containing all the single launchers for each step of the \MASS methodology.
	\begin{itemize}
		\item \texttt{MASS\_STEPS\_LAUNCHERS/PrepareSUT.sh}: launcher for the script that prepares the SUT and collects information about the SUT test suite.
		\item \texttt{MASS\_STEPS\_LAUNCHERS/GenerateMutants.sh}: launcher for the generation of mutants.
		\item \texttt{MASS\_STEPS\_LAUNCHERS/CompileOptimizedMutants.sh}: launcher for the trivial compiler optimization step.
		\item \texttt{MASS\_STEPS\_LAUNCHERS/OptimizedPostProcessing.sh}: launcher for the post-processing of the trivial compiler optimization step.
		\item \texttt{MASS\_STEPS\_LAUNCHERS/GeneratePTS.sh}: launcher for the generation of prioritized and reduced test suites.
		\item \texttt{MASS\_STEPS\_LAUNCHERS/ExecuteMutants.sh}: launcher for the execution of mutants against the SUT test suite.
		\item \texttt{MASS\_STEPS\_LAUNCHERS/IdentifyEquivalents.sh}: launcher for the identification of equivalent mutants based on code coverage.
		\item \texttt{MASS\_STEPS\_LAUNCHERS/MutationScore.sh}: launcher for the computation of the mutation score and final reporting.
		\item \texttt{MASS\_STEPS\_LAUNCHERS/PrepareMutants\_HPC.sh}: HPC launcher that prepares the mutants workspace for the execution on HPCs.
		\item \texttt{MASS\_STEPS\_LAUNCHERS/ExecuteMutants\_HPC.sh}: HPC launcher that executes mutants on HPCs.
		\item \texttt{MASS\_STEPS\_LAUNCHERS/PostMutation\_HPC.sh}: HPC launcher that assesses past mutant executions, and decides whether more mutant executions are needed.
	\end{itemize}

\end{itemize}

\subsection{MASS Configuration}

There are three Bash scripts that should be edited by the engineer to configure \MASS. These three scripts enable \MASS to correctly identify the SUT paths (e.g., source code folder, test suite folder), the SUT compilation commands, the SUT test suite execution commands, and the configuration of \MASS itself (e.g., trivial compiler optimizations flags, mutant selection strategy, sampling rate).

%\DONE{We should have a table with the script name, the parameter to be configured and a description}
Table~\ref{table:to_configure} provides a summary of \MASS configuration files, their parameters, and a brief description. A detailed description of the MASS configuration files follows.


\input{tables/to_configure}



%The last intervention, regards providing a template of the original build script for the trivial compiler optimizations step. More details are provided in the following.



\subsubsection{Edit mass\_conf.sh}

Within file \texttt{\$INSTALL\_DIR/mass\_conf.sh} there are multiple environment variables that must be set; they are shown in Listing~\ref{listing:MASS:conf}.

%\DONE{You should always refer to Figures/Listings in appropriate manner. However, this "style" is ok for the running example.}

\begin{lstlisting}[language=bash,label=listing:MASS:conf,caption=Excerpt of mass\_conf.sh file.]
	# set SRCIROR path
	export SRCIROR=

	# set workspace directory path where MASS files can be stored (i.e., $INSTALL_DIR)
	export APP_RUN_DIR=

	# specifies the building system, available options are "Makefile" and "waf"
	export BUILD_SYSTEM=

	# directory root path of the SUT
	export PROJ=

	# directory source path of the SUT
	export PROJ_SRC=

	# directory test path of the SUT
	export PROJ_TST=

	# directory coverage path of the SUT
	export PROJ_COV=

	# directory path where the compiled binary is stored
	export PROJ_BUILD=

	# list of folders not to be included during coverage analysis, name folders shall be separated by '\|'
	export COVERAGE_NOT_INCLUDE=

	# filename of the compiled file or library
	export COMPILED=

	# path to the original build script
	export ORIGINAL_MAKEFILE=

	# compilation command of the SUT, the command shall be specified as a Bash array, e.g., (). Special characters shall be escaped.
	export COMPILATION_CMD=

	# additional commands for compiling the SUT (e.g., setup of workspace), the command shall be specified as a Bash array, e.g., (). Special characters shall be escaped.
	export ADDITIONAL_CMD=

	# command to be executed after each test case execution (optional), the command shall be specified as a Bash array, e.g., (). Special characters shall be escaped.
	export ADDITIONAL_CMD_AFTER=

	# compilation command for TCE analysis, the command shall be specified as a Bash array, e.g., (). Special characters shall be escaped.
	export TCE_COMPILE_CMD=

	# command to clean installation of the SUT, the command shall be specified as a Bash array, e.g., (). Special characters shall be escaped.
	export CLEAN_CMD=

	# relative path to location of gcov files (i.e., gcda and gcno files)
	export GC_FILES_RELATIVE_PATH=
\end{lstlisting}

Furthermore, the following specific \MASS variables must be set (See Listing~\ref{listing:MASS:conf_2}):

\begin{lstlisting}[language=bash, label=listing:MASS:conf_2, caption=\MASS specific variables. Excerpt of mass\_conf.sh file.]
	# specify if MASS will be executed on an HPC, possible values are "true" or "false"
	export HPC=

	# TCE flags to be tested, the flags shall be specified as a Bash array, e.g., ("-O0" "-O1").
	export FLAGS=

	# set if MASS should be executed with a prioritized and reduced test suite, possible values are "true" or "false"
	export PRIORITIZED=

	# set sampling technique, possible values are "uniform", "stratified", and "fsci"
	# note: if "uniform" or "stratified" is set, $PRIORITIZED must be "false"
	export SAMPLING=

	# set sampling rate if whether "uniform" or "stratified" sampling has been selected
	export RATE=
\end{lstlisting}

\subsubsection{Edit PrepareSUT.sh}

% \TODO{The title should be changed, probably it should become something like \emph{Edit PrepareSUT.sh}. My main problem is that I cannot map this section to something describe before, it comes out of the blue. Also, shouldn't it be a subsubsection? I would expect to have in 4.2.2 the list of all the files to be editng and in the following subsubsections a description for each of them.}

To configure \MASS to work with the SUT, the engineer should also edit the Bash file \\\begin{small}\texttt{\$INSTALL\_DIR/MASS\_STEPS\_LAUNCHER/PrepareSUT.sh}\end{small}. The following actions shall be performed by the engineer:

\begin{enumerate}
	\item Provide commands to generate a compilation database file \texttt{compile\_commands.json} of the SUT. Note that the paths defined within the database file must be full paths. The compilation database file provides the necessary compilation commands of each source for the source mutation step of the methodology.
%	\DONE{Not clear why the engineer should do what written above}
%	\TODO{STill not clear}
	\item Provide commands to compile the SUT;
	\item Provide additional commands to prepare the SUT workspace (optional);
	\item Provide commands to execute the SUT test suite iteratively over each test case; more precisely, the engineer should do the following:
	\begin{itemize}
		\item After the command executing a a test case add a call to \\\texttt{\$MASS/FAQAS-GenerateCodeCoverageMatrixes/FAQAS-CollectCodeCoverage.sh} script;
		\item the script \texttt{FAQAS-CollectCodeCoverage.sh} shall be invoked with two arguments: (i) the test case name, and (ii) the time taken to run the test case in seconds.
	\end{itemize}
\end{enumerate}

\subsubsection{Mutation Script Configuration}

The mutation script configuration file is the Bash file \texttt{mutation\_additional\_functions.sh}. In it, the engineer is expected to implement the Bash function \texttt{run\_tst\_case}.
%Fabrizio: not clear what you mena below
%; must be implemented by the engineer to guarantee a correct mutation testing process.
This function shall receive as argument the name of the test case to be executed. It should execute the command for running the specified test case.
%Why "Particularly" ?
%Particularly,
The function shall return 0, if the test case passes; it shall return 1 if the test case fails.


\subsubsection{Build Script for Compiler Optimizations}

The SUT engineer shall provide a build script for the SUT. Such script shall be placed in the same folder where the original build script resides (a different name shall be used). The script shall have the following characteristics:

\begin{itemize}
	\item The script shall not contain any debugging flag within compilation/linking commands;
	\item The script shall not contain any code coverage flag within compilation/linking commands;
	\item The script shall contain a placeholder for the compiler optimization option, specifically the placeholder \texttt{TCE};
	\item The script shall contain a 'sort' command in the list of source files to be compiled, to ensure that source files are always compiled in the same order;
	%\DONE{Not clear what a source dependency list is, example?}

	In the case of a Makefile, it can be achieved with the following command:

	\texttt{SRC=\$(sort \$(wildcard \$(SourceFolder/*.c))}

	\item The script shall be named the same as the original build script, but with an ending '.template'.
\end{itemize}


\subsection{Running MASS on Single Machines}
\label{sec:singlelaunch}

%\DONE{Add a paragraph that explains that you are going to describe two ways of running MASS}

\MASS can be executed in two modes, \emph{single machine} and \emph{shared resources mode}. The single machine mode provides the advantage of running \MASS in an unsupervised mode, executing the methodology on one step. Instead, the shared resources facilities mode gives the possibility of running multiple steps in parallel and executing a higher number of mutants, in a similar time frame, with respect to the single machine mode. In this section we describe the \emph{single machine}, Section \ref{sec:shared} covers the \emph{shared resources mode}.

%\TODO{You should either (a) specify the files generated for each step, or (b) put a sentence saying that the output/inputs of each step are described in the specification document XY (and you have t draft it by reciclying the old SSS.}
%
%The inputs and outputs of each step are described in the specification document XY.


\subsubsection{One Step Launcher}

The single machine mode gives the possibility of running \MASS in one step, by executing all the eight steps of the framework with one command. The one step launcher will execute the following steps sequentially:

\begin{enumerate}
	\item PrepareSUT
	\item GenerateMutants
	\item CompileOptimizedMutants
	\item OptimizedPostProcessing
	\item GeneratePTS
	\item ExecuteMutants
	\item IdentifyEquivalents
	\item MutationScore
\end{enumerate}

To execute the one step launcher, the following command shall be provided:

\begin{lstlisting}[language=bash]
  $ ./Launcher.sh
\end{lstlisting}

\subsubsection{Multiple Step Launchers}

The single machine mode also gives the possibility to run \MASS by executing all the eight steps of the framework through independent commands.
The multiple steps of the methodology and their respective commands are described in the following.

\begin{enumerate}
	\item \textbf{Prepare the SUT} step can be executed with the following command:

	\begin{lstlisting}[language=bash]
	  $ ./MASS_STEPS_LAUNCHER/PrepareSUT.sh
\end{lstlisting}

	\item \textbf{Generate Mutants} step can be executed with the following command:

	\begin{lstlisting}[language=bash]
	  $ ./MASS_STEPS_LAUNCHER/GenerateMutants.sh
\end{lstlisting}

	\item \textbf{Compile Optimized Mutants} step can be executed with the following command:

	\begin{lstlisting}[language=bash]
	  $ ./MASS_STEPS_LAUNCHER/CompileOptimizedMutants.sh
\end{lstlisting}

	\item \textbf{Compile Optimized Mutants Post-Processing} step can be executed with the following command:

	\begin{lstlisting}[language=bash]
	  $ ./MASS_STEPS_LAUNCHER/OptimizedPostProcessing.sh
\end{lstlisting}

	\item \textbf{Generate Prioritized and Reduced Test Suites} step can be executed with the following command:

	\begin{lstlisting}[language=bash]
	  $ ./MASS_STEPS_LAUNCHER/GeneratePTS.sh
\end{lstlisting}

	\item \textbf{Execute mutants} step can be executed with the following command:

	\begin{lstlisting}[language=bash]
	  $ ./MASS_STEPS_LAUNCHER/ExecuteMutants.sh
\end{lstlisting}

	\item \textbf{Identify Equivalent Mutants based on Code Coverage} step can be executed with the following command:

	\begin{lstlisting}[language=bash]
	  $ ./MASS_STEPS_LAUNCHER/IdentifyEquivalents.sh
\end{lstlisting}

	\item \textbf{Computer Mutation Score} step can be executed with the following command:

	\begin{lstlisting}[language=bash]
	  $ ./MASS_STEPS_LAUNCHER/MutationScore.sh
\end{lstlisting}
\end{enumerate}


\subsection{Running MASS on Shared Resources Facilities}
\label{sec:shared}

Given that resources from HPC infrastructures has to be requested for every performed tasks, it is not possible to run all the steps from \MASS in one step.
However, since resources can be requested accordingly, \MASS can perform multiple steps simultaneously, enhancing the capabilities of the toolset. With an HPC, for example, \MASS could analyze more mutants than if \MASS was executed on a single machine.

The multiple steps of the methodology and their respective commands are described in the following.

\begin{enumerate}
	\item \textbf{Prepare the SUT} step can be executed with the following command:

	\begin{lstlisting}[language=bash]
	  $ ./MASS_STEPS_LAUNCHER/PrepareSUT.sh
\end{lstlisting}

	\item \textbf{Generate Mutants} step can be executed with the following command:

	\begin{lstlisting}[language=bash]
	  $ ./MASS_STEPS_LAUNCHER/GenerateMutants.sh
\end{lstlisting}

	\item \textbf{Compile Optimized Mutants}: 
	%If the environment variable \texttt{HPC} is set to \texttt{true}. 
	A parameter shall be passed to the launcher script to indicate the chosen optimization level. If six levels of optimizations are defined, then numbers between zero and five can be provided.

	\begin{lstlisting}[language=bash]
	  $ level=0
	  $ ./MASS_STEPS_LAUNCHER/CompileOptimizedMutants.sh $level
\end{lstlisting}

	\item \textbf{Compile Optimized Mutants Post-Processing} step can be executed with the following command:

	\begin{lstlisting}[language=bash]
	  $ ./MASS_STEPS_LAUNCHER/OptimizedPostProcessing.sh
\end{lstlisting}

	\item \textbf{Generate Prioritized and Reduced Test Suites} step can be executed with the following command:

	\begin{lstlisting}[language=bash]
	  $ ./MASS_STEPS_LAUNCHER/GeneratePTS.sh
\end{lstlisting}

	\item \textbf{Prepare mutants} step can be executed with the following command:

	\begin{lstlisting}[language=bash]
	  $ ./MASS_STEPS_LAUNCHER/PrepareMutants_HPC.sh
\end{lstlisting}

	\item \textbf{Execute mutants}: The launcher script receives two parameters: the first parameter is the number of the mutant to be executed, defined as ${1..M}$, being M the total number of mutants. The total number of mutants can be derived from the folder \texttt{\$INSTALL\_DIR/hpc-src-mutants}.
	The second parameter defines if the test suite has to be executed in a reduced fashion or not. The possible values are ``true'' and ``false''.

	\begin{lstlisting}[language=bash]
	  $ nr_mutant=1
	  $ reduced="false"
	  $ ./MASS_STEPS_LAUNCHER/ExecuteMutants_HPC.sh $nr_mutant $reduced
\end{lstlisting}

	\item \textbf{Post-mutation execution}: The launcher script receives two numbers as parameters, a minimum and a maximum value, that represent the range of mutants to assess. The assessment consists of evaluating if more mutant executions are needed.

	\begin{lstlisting}[language=bash]
	  $ min=1
	  $	max=700
	  $ ./MASS_STEPS_LAUNCHER/PostMutation_HPC.sh $min $max
\end{lstlisting}

	\item \textbf{Identify Equivalent Mutants based on Code Coverage} step can be executed with the following command:

	\begin{lstlisting}[language=bash]
	  $ ./MASS_STEPS_LAUNCHER/IdentifyEquivalents.sh
\end{lstlisting}

	\item \textbf{Computer Mutation Score} step can be executed with the following command:

	\begin{lstlisting}[language=bash]
	  $ ./MASS_STEPS_LAUNCHER/MutationScore.sh
\end{lstlisting}
\end{enumerate}

\subsection{MASS results}

After the execution of \MASS the results are stored in dedicated folders. Such folders are defined as follows:

\begin{enumerate}
	\item Prepare SUT: the results of this step are stored in the folder \texttt{COV\_FILES}. Besides the coverage files, it contains (i) the coverage matrices, and (ii) the timeout file.
	\item Generate Mutants: the results of this step are stored in the folder \texttt{src-mutants}, it contains all mutant sources.
	\item Compile Optimized Mutants: the results of this step are stored in the folder \texttt{COMPILED} that contains one folder for each optimisation level.
	\item Compile Optimized Mutants Post-Processing: the results of this step are stored in the folder \texttt{COMPILED}. Specifically, it generates four lists: (i) list of all mutants, (ii) list of nonequivalent and nonredundant mutants, (iii) list of equivalent mutants, and (iv) list of redundant mutants.
	\item Generate Prioritized and Reduced Test Suites: the results of this step are stored in the folder \texttt{PRIORITIZED}, which contains one file with the prioritized and reduced test suites, and one file with the prioritized test suites.
	\item Execute Mutants: the results of this step are stored in the folder \texttt{MUTATION}. This step produces several files and folders:
	\begin{itemize}
		\item \texttt{main.csv}: complete mutation traces
		\item \texttt{sampled\_mutants}: list of sampled mutants to be executed
		\item \texttt{all\_live}: list of live mutants
		\item \texttt{all\_killed}: list of killed mutants
		\item \texttt{traces\_live}: live mutants traces
		\item \texttt{traces\_killed}: killed mutants traces
		\item \texttt{mutant folder}: there is one folder for each executed mutant, this folder contains the mutant code coverage information and test cases execution logs.
	\end{itemize}
	\item Identify Equivalent Mutants based on Code Coverage: the results of this step are stored in the folder \texttt{DETECTION}.
	\item Compute Mutation Score: the results of this step are stored in folder \texttt{RESULTS}. Particularly, the file \texttt{MASS\_RESULTS} contains the final output of \MASS.
\end{enumerate}


% \section{Mode selection and control}

% \section{Normal Operations}

\section{Normal Termination}

%\DONE{"The SUM shall describe how the user can cease or interrupt use of the software and how to determine whether normal termination or cessation has occurred."}

Each methodology step of \MASS is executed when invoked and computes a result. There is no software interruption foreseen during the computation and the procedure terminates by returning the result.
If the engineer decides to interrupt \MASS execution, it can be done by sending a signal interrupt \texttt{SIGINT} to the running process.

\section{Error Conditions}

%\DONE{Can 't we say anything about each program not returning any error message?}

There is no error condition handling in the \FAQAS. If all preconditions are met, there should not be any error.

\section{Recover Runs}

%\DONE{Shall we say that an engineer can restart the process form a task if all the precondiions are met?}

If for any reason the execution of \MASS is interrupted, an engineer can restart the process from a specific task if all preconditions are met. This is possible since each \MASS step work by processing data that is permanently stored by previous steps.
