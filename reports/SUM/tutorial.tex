% !TEX root = MAIN.tex

\chapter{Tutorial}

\section{Introduction}

This tutorial presents how to use \MASS on a typical case. Since \MASS provides two modes of execution (i.e., running \MASS on a single machine and running \MASS on HPC infrastructures), we provide an example for both.

Both examples use the Mathematical Library for Flight Software as case study to exemplify the steps to follow for the use of \FAQAS.

\section{Getting Started}

\TODO{?}

\section{Using the software on a typical task}

\subsection{Single Machine Example: Mathematical Library for Flight Software}

The first step regards installing the \MASS framework, please refer to Section~\ref{sec:install}.

The second step, consists of creating and installing a workspace folder for running \MASS on the MLFS example. For this case, the workspace folder will be created on \texttt{/opt/MLFS}.

\begin{lstlisting}[language=bash]
  $ cd $FAQAS/MASS/FAQAS-Setup
  $ export INSTALL_DIR=/opt/MLFS
  $ ./install.sh
\end{lstlisting}

The third step consists of configuring the \MASS configuration file \texttt{mass\_conf.sh}. In the following, we provide excerpts of the file that require intervention from the engineer. The following excerpt contains the necessary configuration for the MLFS case study.

\begin{lstlisting}[language=bash]
# set FAQAS path
export SRCIROR=/opt/srcirorfaqas
                                                     
...

# set directory path where MASS files can be stored
export APP_RUN_DIR=/opt/MLFS

# specifies the building system, available options are "Makefile" and "waf"
export BUILD_SYSTEM="Makefile"

# directory root path of the software under test
export PROJ=$HOME/mlfs

# directory src path of the SUT
export PROJ_SRC=$PROJ/libm

# directory test path of the SUT
export PROJ_TST=$HOME/unit-test-suite

# directory coverage path of the SUT
export PROJ_COV=$HOME/blts_workspace

# directory path of the compiled binary
export PROJ_BUILD=$PROJ/build-host/bin

# filename of the compiled file/library
export COMPILED=libmlfs.a

# path to original Makefile
export ORIGINAL_MAKEFILE=$PROJ/Makefile

# compilation command of the SUT
export COMPILATION_CMD=(make all ARCH=host EXTRA_CFLAGS="-DNDEBUG" \&\& make all COVERAGE="true" ARCH=host_cov EXTRA_CFLAGS="-DNDEBUG")

# compilation additional commands of the SUT (e.g., setup of workspace)
export ADDITIONAL_CMD=(cd $HOME/blts/BLTSConfig \&\& make clean install INSTALL_PATH="$HOME/blts_install" \&\& cd $HOME/blts_workspace \&\& $HOME/blts_install/bin/blts_app --init)

# command to be executed after each test case (optional)
export ADDITIONAL_CMD_AFTER=(rm -rf $HOME/blts_workspace/*)

# compilation command for TCE analysis
export TCE_COMPILE_CMD=(make all ARCH=host EXTRA_CFLAGS="-DNDEBUG")

# command to clean installation of the SUT
export CLEAN_CMD=(make cleanall)

# relative path to location of gcov files (i.e., gcda and gcno files)
export GC_FILES_RELATIVE_PATH=Reports/Coverage/Data
\end{lstlisting}

Also \MASS variables shall be configured within the same file. Particularly, we will run \MASS with the following setup. 

\begin{lstlisting}[language=bash]
### MASS variables

# TCE flags to be tested 
export FLAGS=("-O0" "-O1" "-O2" "-O3" "-Ofast" "-Os")

# specify if MASS will be executed on a HPC, possible values are "true" or "false"
export HPC="false"

# set if MASS should be executed with a prioritized and reduced test suite
export PRIORITIZED="true"

# set sampling technique, possible values are "uniform", "stratified", and "fsci"
# note: if "uniform" or "stratified" is set, $PRIORITIZED must be "false"
export SAMPLING="fsci"

# set sampling rate if whether "uniform" or "stratified" sampling has been selected
export RATE=""
\end{lstlisting}

The fourth step consists of configuring the prepare SUT configuration file \\(\texttt{/opt/MLFS/MASS\_STEPS\_LAUNCHER/PrepareSUT.sh}; within this file the following actions must be provided by the engineer:


\begin{lstlisting}[language=bash]
#!/bin/bash

# This file should be prepared by the engineer!                                                                                           
cd /opt/MLFS
. ./mass_conf.sh

# 1. Compile SUT
## example

cd $PROJ

# # generate compile_commands.json and delete build
bear make all && rm -rf build* && sed -i 's: libm: /home/mlfs/mlfs/libm:' compile_commands.json && mv compile_commands.json $MUTANTS_DIR
eval "${COMPILATION_CMD[@]}"

# 2. Prepare test scripts
# example

cd $HOME/blts/BLTSConfig
make clean install INSTALL_PATH="$HOME/blts_install"

# Preparing MLFS workspace (e.g., where test cases data is stored)
cd $HOME/blts_workspace
$HOME/blts_install/bin/blts_app --init

# 3. Execute test cases
# Note: execution time for each test case should be measured and passed as argument to FAQAS-CollectCodeCoverage.sh

# example
for tst in $(find $HOME/unit-test-suite -name '*.xml');do
    cd $HOME/blts_workspace

    tst_filename_wo_xml=$(basename -- $tst .xml)
    
    start=$(date +%s)
    $HOME/blts_install/bin/blts_app -gcrx $tst_filename_wo_xml -b coverage --nocsv -s $tst
    end=$(date +%s)    

    # call to FAQAS-CollectCodeCoverage.sh
    # parameter should be test case name and the execution time
    source $MASS/FAQAS-GenerateCodeCoverageMatrixes/FAQAS-CollectCodeCoverage.sh $tst_filename_wo_xml "$(($end-$start))" $PROJ_COV
done
\end{lstlisting}

The fifth step consists of defining the function \texttt{run\_tst\_case} within the file \\\texttt{mutation\_additional\_functions.sh}:

\begin{lstlisting}[language=bash]
run_tst_case() {

    tst_name=$1
    tst=$PROJ_TST/$tst_name.xml

    echo $tst_name $tst

    # run the test case
    cd $PROJ_COV
    $HOME/blts_install/bin/blts_app -gcrx $tst_name -b coverage --nocsv -s $tst

    # define if test case execution passed or failed
    summaryreport=$tst_name/Reports/SessionSummaryReport.xml
    originalreport=$HOME/unit-reports/$summaryreport

    test_cases_failed=`xmllint --xpath "//report_summary/test_set_summary/test_cases_failed/text()" $summaryreport`
    o_test_cases_failed=`xmllint --xpath "//report_summary/test_set_summary/test_cases_failed/text()" $originalreport`

    echo "comparing with original execution" 
    echo $test_cases_failed $o_test_cases_failed 

    if [ "$test_cases_failed" != "$o_test_cases_failed" ]; then
        return 1
    else
        return 0
    fi
}
\end{lstlisting}

The sixth step consists of providing a template for the build script for the trivial compiler optimizations step. In particular, we replaced the following command: 

\begin{lstlisting}[language=bash]
CFLAGS = -c -Wall -std=gnu99 -pedantic -Wextra -frounding-math -fsignaling-nans -g O2 -fno-builtin $(EXTRA_CFLAGS)
\end{lstlisting}

with the following one:

\begin{lstlisting}[language=bash]
CFLAGS = -c -Wall -std=gnu99 -pedantic -Wextra -frounding-math -fsignaling-nans TCE -fno-builtin $(EXTRA_CFLAGS)
\end{lstlisting}

The seventh step consists of launching the one step launcher (see Section~\ref{sec:singlelaunch}:

\begin{lstlisting}[language=bash]
 $ /opt/MLFS/Launcher.sh
\end{lstlisting}

The following results shall be reported at the end of the execution:

\begin{lstlisting}[language=bash]
##### MASS Output #####                                                                                                                   
## Total mutants generated: 28071
## Total mutants filtered by TCE: 6918
## Sampling type: fsci
## Total mutants analyzed: 461
## Total killed mutants: 369
## Total live mutants: 92
## Total likely equivalent mutants: 53
## MASS mutation score (%): 90.44
## List A of useful undetected mutants: /opt/MLFS/RESULTS/useful_list_a
## List B of useful undetected mutants: /opt/MLFS/RESULTS/useful_list_b
## Number of statements covered: 1973
## Statement coverage (%): 100
## Minimum lines covered per source file: 2
## Maximum lines covered per source file: 138
\end{lstlisting}


\subsection{HPC Infrastructure Example: Mathematical Library for Flight Software}

The first step regards installing the \MASS framework, please refer to Section~\ref{sec:install}.

\TODO{To complete?}