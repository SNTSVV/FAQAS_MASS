% !TEX root = MAIN.tex

\chapter{SEMUS - ASN.1 Tutorial}
\label{chapter:semus:tutorial}

\section{Introduction}

This tutorial instructs on how to use \SEMUS on the ASN.1 case study provided by ESA.

\section{Running \SEMUS}
\label{sec:semus_running}

For running \SEMUS the user needs to set up the toolset, for this task please refer to Section~\ref{sec:install:semus}.

The objective of this tutorial is to generate test inputs that kill the mutants non detected by the ASN.1 test suite. For this reason, we consider a precondition of this tutorial to have applied \MASS to the ASN.1 case study, and thus to have the list of live mutants.

We consider as a target of the test generation the autogenerated code from ASN.1, i.e., \texttt{test.c}.

\SEMUS is distributed with a set of scripts already configured, meaning that the user does not need to edit them. All the code concerning the ASN.1 case study can be found on \texttt{faqas\_semu/case\_studies/ASN/}. 

In general, the steps for generating tests for the ASN.1 case study are:

\begin{enumerate}
    \item Configure the file \texttt{faqas\_semus\_config.sh} (Already filled by SnT).
    \item Configure the \texttt{generate\_template\_config.json} file (Already filled by SnT).
    \item Generate the test templates for the SUT functions.
    \item Launch the test generation process for the case study.
    \item Verifying the generated unit test cases.
\end{enumerate}


\subsection{Step 1: configuring \SEMUS}

The first step consists of configuring \SEMUS; for doing so it is necessary to provide the paths for the SUT paths, the SUT compilation commands, the output folders, and the configuration of \SEMU for guiding the symbolic search. Listing~\ref{listing:ASN:conf} provides an example of configuration file for the case study, in this case, we already provide a filled version of it, the file can be found at \begin{footnotesize}\texttt{faqas\_semu/case\_studies/ASN/scripts/faqas\_semus\_conf.sh}\end{footnotesize}: 

\begin{lstlisting}[language=bash,label=listing:ASN:conf,caption=faqas\_semus\_conf.sh file for ASN case study.]
FAQAS_SEMU_CASE_STUDY_TOPDIR=../

FAQAS_SEMU_CASE_STUDY_WORKSPACE=$FAQAS_SEMU_CASE_STUDY_TOPDIR/WORKSPACE

FAQAS_SEMU_OUTPUT_TOPDIR=$FAQAS_SEMU_CASE_STUDY_WORKSPACE/OUTPUT

FAQAS_SEMU_GENERATED_MUTANTS_TOPDIR=$FAQAS_SEMU_OUTPUT_TOPDIR/mutants_generation

FAQAS_SEMU_REPO_ROOTDIR=$FAQAS_SEMU_CASE_STUDY_WORKSPACE/DOWNLOADED/casestudy

FAQAS_SEMU_ORIGINAL_SOURCE_FILE=$FAQAS_SEMU_REPO_ROOTDIR/test.c

FAQAS_SEMU_COMPILE_COMMAND_SPECIFIED_SOURCE_FILE=./test.c

FAQAS_SEMU_GENERATED_MUTANTS_DIR=$FAQAS_SEMU_GENERATED_MUTANTS_TOPDIR/test

FAQAS_SEMU_BUILD_CODE_FUNC_STR='
FAQAS_SEMU_BUILD_CODE_FUNC()
{
    local in_file=$1
    local out_file=$2
    local repo_root_dir=$3
    local compiler=$4
    local flags="$5"
    # compile
    $compiler $flags -g -Wall -Werror -Wextra -Wuninitialized -Wcast-qual -Wshadow -Wundef -fdiagnostics-show-option -D_DEBUG -I $repo_root_dir -O0 $in_file -o $out_file $flags
    return $?
}
'

FAQAS_SEMU_BUILD_LLVM_BC()
{
    local in_file=$1
    local out_bc=$2
    eval "$FAQAS_SEMU_BUILD_CODE_FUNC_STR"
    FAQAS_SEMU_BUILD_CODE_FUNC $in_file $out_bc $FAQAS_SEMU_REPO_ROOTDIR clang '-c -emit-llvm'
    return $?
}

FAQAS_SEMU_META_MU_TOPDIR=$FAQAS_SEMU_OUTPUT_TOPDIR/meta_mu_topdir

FAQAS_SEMU_GENERATED_META_MU_SRC_FILE=$FAQAS_SEMU_GENERATED_MUTANTS_TOPDIR/test.MetaMu.c

FAQAS_SEMU_GENERATED_META_MU_BC_FILE=$FAQAS_SEMU_GENERATED_MUTANTS_TOPDIR/test.MetaMu.bc

FAQAS_SEMU_GENERATED_META_MU_MAKE_SYM_TOP_DIR=$FAQAS_SEMU_GENERATED_MUTANTS_TOPDIR/"MakeSym-TestGen-Input"

FAQAS_SEMU_GENERATED_TESTS_TOPDIR=$FAQAS_SEMU_OUTPUT_TOPDIR/test_generation

# timeout in seconds
FAQAS_SEMU_TEST_GEN_TIMEOUT=300

# This is the config for SEMU heuristics. The accepted values of 'PSS' are 'RND' for random and 'MDO' for minimum distance to output
FAQAS_SEMU_HEURISTICS_CONFIG='{
        "PL": "0",
        "CW": "4294967295",
        "MPD": "0",
        "PP": "1.0",
        "NTPM": "5",
        "PSS": "RND"
}'

# max Test Generation memory in MB
FAQAS_SEMU_TEST_GEN_MAX_MEMORY=2000

# Set to 'ON' to stop test generation when the memory limit is reached
FAQAS_SEMU_STOP_TG_ON_MEMORY_LIMIT='OFF'

# Set this to 'ON' so thae the states the sate fork is disabled when the memory limit is reached, to avoid going much over it
FAQAS_SEMU_TG_MAX_MEMORY_INHIBIT="ON"
\end{lstlisting}

Concerning \SEMU configuration, we can see that we have setup the tool to run for a maximum of 5 minutes, and to use a maximum of 2000 MB of memory.

\subsection{Step 2 and 3: configuring the \texttt{generate\_template\_config.json} file and generating test templates}

In this step, we need to configure the \texttt{generate\_template\_config.json}, remember that this JSON file provides detailed information about how to interpret SUT function to \SEMUS.
Listing~\ref{listing:ASN:json} shows an example of configuration JSON file for the case study. 
It indicates that the parameter \emph{pErrCode} acts as an output parameter (see \emph{OUT\_ARG\_NAMES}). 
Also, it provides customized instructions to specify how to instantiate and initialize variables; for instance, the listing shows that the type \texttt{struct BitStream\_t} shall be initialized with the support of the \texttt{BitStream\_Init} function.

\begin{lstlisting}[language=bash,label=listing:ASN:json,caption=JSON configuration file for ASN.1.]
{
    "TYPES_TO_INTCONVERT": {"flag": "(int){}"},
    "TYPES_TO_PRINTCODE": {},
    "OUT_ARGS_NAMES": ["pErrCode"],
    "IN_OUT_ARGS_NAMES": [],
    "TYPE_TO_INITIALIZATIONCODE": {"struct BitStream_t": "static byte encBuff[T_POS_SET_REQUIRED_BYTES_FOR_ENCODING + 1];\n\tBitStream_Init(&{}, encBuff, T_POS_SET_REQUIRED_BYTES_FOR_ENCODING)"},
    "TYPE_TO_SYMBOLIC_FIELDS_ACCESS": {"struct BitStream_t": {}},
    "VOID_ARG_SUBSTITUTE_TYPE": "",
    "ARG_TYPE_TO_ITS_POINTER_ELEM_NUM": {}
}
\end{lstlisting}

To generate the the test templates, the user shall execute the Python script \texttt{generate\_direct.py} for the generation of test templates by passing as argument (1) the source file to be analyzed, (2) the include argument of the library, (3) the \texttt{generate\_template\_config.json} file.

\begin{lstlisting}[language=bash]
$ ./generate_direct.py ../WORKSPACE/DOWNLOADED/casestudy/test.c direct " -I../WORKSPACE/DOWNLOADED/casestudy/" -c generate_template_config.json
\end{lstlisting}

The previous command will generate the following template for the \texttt{T\_POS\_SET\_Encode} function.

\begin{lstlisting}[style=CStyle]
#include <stdio.h>
#include <string.h>

#include "asn1crt.c"
#include "asn1crt_encoding.c"
#include "asn1crt_encoding_uper.c"

#include "klee/klee.h"

int main(int argc, char** argv)
{
    (void)argc;
    (void)argv;

    // Declare variable to hold function returned value
    _Bool result_faqas_semu;

    // Declare arguments and make input ones symbolic
    T_POS_SET pVal;
    struct BitStream_t pBitStrm;
    int pErrCode;
    _Bool bCheckConstraints;
    memset(&pVal, 0, sizeof(pVal));
    memset(&bCheckConstraints, 0, sizeof(bCheckConstraints));
    static byte encBuff[T_POS_SET_REQUIRED_BYTES_FOR_ENCODING + 1];
    BitStream_Init(&pBitStrm, encBuff, T_POS_SET_REQUIRED_BYTES_FOR_ENCODING);
    klee_make_symbolic(&pVal, sizeof(pVal), "pVal"); //T_POS_SET
    klee_make_symbolic(&bCheckConstraints, sizeof(bCheckConstraints), "bCheckConstraints"); //_Bool

    // Call function under test
    result_faqas_semu = T_POS_SET_Encode(&pVal, &pBitStrm, &pErrCode, bCheckConstraints);

    // Make some output
    printf("FAQAS-SEMU-TEST_OUTPUT: pErrCode = %d\n", pErrCode);
    printf("FAQAS-SEMU-TEST_OUTPUT: result_faqas_semu = %d\n", result_faqas_semu);
    return (int)result_faqas_semu;
}
\end{lstlisting}

% After the test generation the user shall delete the lines 24 and 29, since we do not need \SEMUS to interpret \texttt{pBitStrm} as symbolic.

\subsection{Step 4: launching the test generation process}

For the sake of this tutorial we consider the test generation for mutants of the function \texttt{T\_POS\_SET\_Encode}. For this, the user shall provide a file text containing the name of the mutants, and will place it in folder \url{case\_studies/ASN/WORKSPACE/DOWNLOADED/live\_mutant}.

The engineer shall then execute one test generation command (i.e., invoke the script \emph{run.sh}), the command follows:

\begin{lstlisting}[language=bash]
 $ scripts/run.sh mutation WORKSPACE/DOWNLOADED/live_mutant WORKSPACE/OUTPUT/live_mutants_output
\end{lstlisting}

\subsection{Step 5: verifying the generated test cases}

\SEMUS' output is stored in the directory \texttt{WORKSPACE/OUTPUT/live\_mutants\_output}. The generated unit test cases are stored in the directory \begin{small}\texttt{live\_mutants\_output/test\_generation/<test template name>/<function under test>/FAQAS\_SEMU-out/produced-unittests}\end{small}.

For example, after test generation, in the folder \texttt{produced-unittests} that has been created by \SEMUS when testing the function \texttt{T\_POS\_SET\_Encode}, we will find the following files:

\begin{itemize}
\item runtest.sh
\item test000001.ktest.c
\item test000001.ktest.c.expected
\item test000002.ktest.c
\item test000002.ktest.c.expected
\end{itemize}

The Bash script \texttt{runtest.sh} provides the necessary commands to execute the generated test case, the files with suffix \texttt{.ktest.c}  are the test cases generated by \SEMUS, while the files with extension \emph{.expected} contain the output that is observed when executing the test case with the current version of the SUT.

The generated test case can be executed using the following command:

\begin{lstlisting}[language=bash]
 $ ./runtest.sh test000001.ktest.c
\end{lstlisting}

The command above will generate the text file \texttt{test000001.ktest.c.got}, which stores the system outputs generated during the execution of the test case. The script will also compare the observed output (i.e., the file with extension \emph{.got}) with the output generated during test generation (i.e., the file with extension \emph{.expected}) through a \emph{diff} command. If the function under test was not modified, the \texttt{runtest.sh} script should not output any difference. 

The command \texttt{runtest.sh} becomes handy in a CI/CD context; indeed, the test cases generated by \SEMUS can be reused as is to determine regression fault. When a new version of the SUT is available, the engineers can simply replace the content of FAQAS\_SEMU\_REPO\_ROOTDIR (i.e., the folder with the SUT) with the newer SUT version. The execution of command \texttt{runtest.sh} will thus show the presence of differences with respect to a previous version. If the function under test has not been updated in the new version, the presence of changes may indicate a regression.

Additionally, the user may generate the summary report of \SEMUS, through the following command:

\begin{lstlisting}[language={}, label=listing:semus_results]
 $ ./generateReport.sh
\end{lstlisting}


The output of this command can be found at \begin{scriptsize}\url{case_studies/$SUT/WORKSPACE/OUTPUT/AnalysisReport.csv}\end{scriptsize}:

\begin{lstlisting}[language={}]
Number of analyzed mutants: 20
Number of killed mutants: 2
Number of live mutants: 18
test.mut.2489.1_1_2.SDL.T_POS_SET_Encode.c;KILLED
test.mut.2489.2_1_14.ICR.T_POS_SET_Encode.c;LIVE
test.mut.2489.1_2_14.ICR.T_POS_SET_Encode.c;LIVE
test.mut.2490.4_1_74.LVR.T_POS_SET_Encode.c;LIVE
test.mut.2491.2_1_10.LCR.T_POS_SET_Encode.c;LIVE
test.mut.2491.2_2_10.LOD.T_POS_SET_Encode.c;LIVE
test.mut.2491.1_1_6.LOD.T_POS_SET_Encode.c;LIVE
test.mut.2491.2_5_23.ROR.T_POS_SET_Encode.c;LIVE
test.mut.2491.4_3_23.ROR.T_POS_SET_Encode.c;LIVE
test.mut.2502.4_8_97.ICR.T_POS_SET_Encode.c;LIVE
test.mut.2502.5_9_97.ICR.T_POS_SET_Encode.c;LIVE
test.mut.2504.2_2_66.LOD.T_POS_SET_Encode.c;LIVE
test.mut.2504.6_1_32.ROR.T_POS_SET_Encode.c;LIVE
test.mut.2506.5_1_96.LVR.T_POS_SET_Encode.c;KILLED
test.mut.2510.5_9_94.ICR.T_POS_SET_Encode.c;LIVE
test.mut.2510.4_8_94.ICR.T_POS_SET_Encode.c;LIVE
test.mut.2512.6_1_36.ROR.T_POS_SET_Encode.c;LIVE
test.mut.2518.5_1_86.LVR.T_POS_SET_Encode.c;LIVE
test.mut.2521.5_1_90.LVR.T_POS_SET_Encode.c;LIVE
test.mut.2524.5_1_98.LVR.T_POS_SET_Encode.c;LIVE
\end{lstlisting}