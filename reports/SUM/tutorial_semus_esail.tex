% !TEX root = MAIN.tex

\chapter{SEMUS - ESAIL Tutorial}
\label{chapter:semus:tutorial:esail}

\section{Introduction}

This tutorial instructs on how to use \SEMUS on the ESAIL Case Study provided by LuxSpace.

\section{Running \SEMUS}
\label{sec:semus_running}

Firstly, the user needs to set up the \SEMUS toolset, please refer to Section~\ref{sec:install:semus}. For this tutorial, we have distributed to LuxSpace a Singularity container with \SEMUS already configured and installed on it, the toolset can be found at \texttt{/opt/faqas\_semu}, being the case study installed at the relative path \texttt{faqas\_semu/case\_studies/ESAIL}.

The objective of this tutorial is to generate test inputs that kill ESAIL mutants, the generated inputs will be then executed through the ESAIL unit test suite harness.

For the sake of this tutorial, we consider one source from the \texttt{ProtocolLayer}, more specifically the \texttt{TMFrameBuilder.c} component.

We assume that the engineer has already properly setup and initialized the workspace for \SEMUS (see Section~\ref{sec:semus:initialization}). The steps for test generation on the ESAIL case study are:

\begin{enumerate}
    \item Configure the file \texttt{faqas\_semus\_config.sh}
    \item Configure the \texttt{generate\_template\_config.json} file
    \item Generate the test templates for the SUT functions
    \item Launch the test generation process for the case study
    \item Verify the generated unit test cases
\end{enumerate}


\subsection{Step 1: configuring \SEMUS}

The first step consists of configuring \SEMUS; for doing so it is necessary to provide the paths for the SUT paths, the SUT compilation commands, the output folders, and the configuration of \SEMU for guiding the symbolic search. Listing~\ref{listing:ESAIL:conf} provides an example of configuration file for the case study, the file can be found at \begin{footnotesize}\texttt{/opt/faqas\_semu/case\_studies/ESAIL/scripts/faqas\_semus\_conf.sh}\end{footnotesize}: 

\begin{lstlisting}[language=bash,label=listing:ESAIL:conf,caption=faqas\_semus\_conf.sh file for ESAIL case study.]
FAQAS_SEMU_CASE_STUDY_TOPDIR=../

FAQAS_SEMU_CASE_STUDY_WORKSPACE=$FAQAS_SEMU_CASE_STUDY_TOPDIR/WORKSPACE

FAQAS_SEMU_OUTPUT_TOPDIR=$FAQAS_SEMU_CASE_STUDY_WORKSPACE/OUTPUT/"${ENV_FAQAS_SEMU_SRC_FILE%.c}"

FAQAS_SEMU_GENERATED_MUTANTS_TOPDIR=$FAQAS_SEMU_OUTPUT_TOPDIR/mutants_generation

FAQAS_SEMU_REPO_ROOTDIR=$FAQAS_SEMU_CASE_STUDY_WORKSPACE/DOWNLOADED/Obsw

FAQAS_SEMU_ORIGINAL_SOURCE_FILE=$FAQAS_SEMU_REPO_ROOTDIR/"${ENV_FAQAS_SEMU_SRC_FILE}"

FAQAS_SEMU_COMPILE_COMMAND_SPECIFIED_SOURCE_FILE=./"${ENV_FAQAS_SEMU_SRC_FILE}"

FAQAS_SEMU_GENERATED_MUTANTS_DIR=$FAQAS_SEMU_GENERATED_MUTANTS_TOPDIR/"${ENV_FAQAS_SEMU_SRC_FILE%.c}"

FAQAS_SEMU_BUILD_CODE_FUNC_STR='
FAQAS_SEMU_BUILD_CODE_FUNC()
{
    local in_file=$1
    local out_file=$2
    local repo_root_dir=$3
    local compiler=$4
    local flags="$5"
    # compile
    $compiler $flags -fdata-sections -ffunction-sections -Wall -DASW_VERSION_MAJOR=4 -DASW_VERSION_MINOR=1 -DSVN_REVISION=0 -DDEBUG -DUNIT_TEST -O0 -g -DTARGET -I$repo_root_dir/Source/_Ext/check_for_target/include/ -DLOG_WCET -DSCHEDULER_TRACKING -I$repo_root_dir/Source/./. -I$repo_root_dir/Source/ApplicationLayer/. -I$repo_root_dir/Source/ServiceLayer/. -I$repo_root_dir/Source/HighLevelDriverLayer/. -I$repo_root_dir/Source/HighLevelDriverLayer/CAN_Handler/Private/. -I$repo_root_dir/Source/ProtocolLayer/. -I$repo_root_dir/Source/LowLevelDriverLayer/. -I$repo_root_dir/Source/Utilities/. -I/opt/rtems-4.8-SAT-AIS/sparc-rtems4.8/leon3/lib/include -I$repo_root_dir/Source/_Ext/mlfs/include -o $out_file $in_file $flags
    return $?
}
'

FAQAS_SEMU_BUILD_LLVM_BC()
{
    local in_file=$1
    local out_bc=$2
    eval "$FAQAS_SEMU_BUILD_CODE_FUNC_STR"
    FAQAS_SEMU_BUILD_CODE_FUNC $in_file $out_bc $FAQAS_SEMU_REPO_ROOTDIR clang '-c -emit-llvm'
    return $?
}

FAQAS_SEMU_META_MU_TOPDIR=$FAQAS_SEMU_OUTPUT_TOPDIR/meta_mu_topdir

FAQAS_SEMU_GENERATED_META_MU_SRC_FILE=$FAQAS_SEMU_GENERATED_MUTANTS_TOPDIR/"${ENV_FAQAS_SEMU_SRC_FILE%.c}".MetaMu.c

FAQAS_SEMU_GENERATED_META_MU_BC_FILE=$FAQAS_SEMU_GENERATED_MUTANTS_TOPDIR/"${ENV_FAQAS_SEMU_SRC_FILE%.c}".MetaMu.bc

FAQAS_SEMU_GENERATED_META_MU_MAKE_SYM_TOP_DIR=$FAQAS_SEMU_GENERATED_MUTANTS_TOPDIR/"MakeSym-TestGen-Input"

FAQAS_SEMU_GENERATED_TESTS_TOPDIR=$FAQAS_SEMU_OUTPUT_TOPDIR/test_generation

# timeout in seconds
FAQAS_SEMU_TEST_GEN_TIMEOUT=300

# This is the config for SEMU heuristics. The accepted values of 'PSS' are 'RND' for random and 'MDO' for minimum distance to output
FAQAS_SEMU_HEURISTICS_CONFIG='{
        "PL": "0",
        "CW": "4294967295",
        "MPD": "0",
        "PP": "1.0",
        "NTPM": "5",
        "PSS": "RND"
}'

# max Test Generation memory in MB
FAQAS_SEMU_TEST_GEN_MAX_MEMORY=2000

# Set to 'ON' to stop test generation when the memory limit is reached
FAQAS_SEMU_STOP_TG_ON_MEMORY_LIMIT='OFF'

# Set this to 'ON' so thae the states the sate fork is disabled when the memory limit is reached, to avoid going much over it
FAQAS_SEMU_TG_MAX_MEMORY_INHIBIT="ON"
\end{lstlisting}

Concerning \SEMU configuration, we can see that we have setup the tool to run for a maximum of 5 minutes, and to use a maximum of 2000 MB of memory.

\subsection{Step 2 and 3: configuring the \texttt{generate\_template\_config.json} files and generating test templates}

For the generation of test templates we provide a Bash script that automates the invocation of the script \texttt{generate\_direct.py} for a specific source. This script is called \texttt{call\_generate\_direct.sh}, and receives the relative path to the source under test. 
Please note that a different configuration for \texttt{generate\_template\_config.json} is required for each source file to test.

Furthermore, as a demonstration we provide an example of the \texttt{generate\_template\_config.json} file for the source considered in this tutorial. 

The example can be found at the path \begin{small}\texttt{case\_studies/ESAIL/util\_codes/template\_configs}\end{small}.

Listing~\ref{listing:ESAIL:TMFrameBuilder} shows an example of configuration JSON file for the source file \emph{TMFrameBuilder.c}. For instance, it indicates that the parameter \emph{headerValues} acts as an output parameter (see \emph{OUT\_ARG\_NAMES}). Also, it provides customized instructions to specify which and how fields of the output variables shall be printed; in turn, this indicates which fields shall be used to consider a mutant killed. Indeed, within \emph{TYPES\_TO\_PRINTCODE} we specify that for the type \emph{unsigned short []} the tool shall print the values with the format \texttt{\%hu}.

\begin{lstlisting}[language=bash,label=listing:ESAIL:TMFrameBuilder,caption=JSON configuration file for TMFrameBuilder.c.]
{
    "TYPES_TO_INTCONVERT": {},
    "TYPES_TO_PRINTCODE": {"unsigned short []": "printf(\"FAQAS-SEMU-TEST_OUTPUT: headerValues = %hu\\n\", {});", "unsigned char []": "printf(\"FAQAS-SEMU-TEST_OUTPUT: destination = %hc\\n\", {});", "struct TmByteField_s": "printf(\"FAQAS-SEMU-TEST_OUTPUT: item.size = %u, item.data = %s\\n\", {}.size, {}.data);"},
    "OUT_ARGS_NAMES": ["headerValues", "destination", "item"],
    "IN_OUT_ARGS_NAMES": [],
    "TYPE_TO_INITIALIZATIONCODE": {},
    "TYPE_TO_SYMBOLIC_FIELDS_ACCESS": {},
    "VOID_ARG_SUBSTITUTE_TYPE": "",
    "ARG_TYPE_TO_ITS_POINTER_ELEM_NUM": {}
}
\end{lstlisting}

The engineer shall execute the Bash script \texttt{call\_generate\_direct.sh} for the generation of test templates with the following command.

\begin{lstlisting}[language=bash]
$ case_studies/ESAIL/util_codes/call_generated_direct.sh Source/ProtocolLayer/TMFrameBuilder/Source/TMFrameBuilder.c
\end{lstlisting}

\subsection{Step 4: launching the test generation process}

Since the test generation targets the source file \begin{small}\texttt{TMFrameBuilder.c}\end{small}, we provide in folder\\
\texttt{case\_studies/ESAIL/WORKSPACE/DOWNLOADED/} a list of mutants for the source file. 
Since we are executing the example in a Singularity container, we execute the test generation through the \texttt{run.sh} script, and not through the wrapper \texttt{docker\_run.sh}, as explained in Chapter~\ref{chapter:semus:operations}.

The engineer shall execute one test generation command (i.e., invoke the script \emph{run.sh}) for each source file to generate test cases for. The command to execute the test generation follows:

\begin{lstlisting}[language=bash]
 $ ENV_FAQAS_SEMU_SRC_FILE=Source/ProtocolLayer/TMFrameBuilder/Source/TMFrameBuilder.c ./run.sh mutation ../WORKSPACE/DOWNLOADED/live-Source.ProtocolLayer.TMFrameBuilder.Source.TMFrameBuilder  ../WORKSPACE/OUTPUT/live_mutants_output
\end{lstlisting}

\subsection{Step 5: verifying the generated test cases}

\SEMUS' output is stored in the directory \texttt{WORKSPACE/OUTPUT/live\_mutants\_output}. The generated unit test cases are stored in the directory \begin{small}\texttt{live\_mutants\_output/test\_generation/<test template name>/<function under test>/FAQAS\_SEMU-out/produced-unittests}\end{small}.

For example, after test generation, in the folder \texttt{produced-unittests} that has been created by \SEMUS when testing the function \texttt{TMFillHeaderValues}  of the source file \texttt{TMFrameBuilder.c}, we will find the following files:

\begin{itemize}
\item TMFillHeaderValues\_unittest.c
\item test000001.ktest.c
\item test000002.ktest.c
\item test000003.ktest.c
\item test000004.ktest.c
\item test000005.ktest.c
\item test000006.ktest.c
\item test000007.ktest.c
\item test000008.ktest.c
\end{itemize}

The files with suffix \texttt{.ktest.c}  are the test cases generated by \SEMUS, while the file \texttt{*\_unittest.c} contains the multiple \texttt{.ktest.c} files wrapped up in a single file with the corresponding headers. This file is compatible with the Check testing framework used in the ESAIL unit test suite. LuxSpace engineers should take care of importing the different \texttt{*\_unittest.c} files into the ESAIL environment, and add the corresponding build scripts for them execution.

The test cases generated by \SEMUS can be reused as is to determine regression fault. When a new version of the SUT is available, engineers can execute the different \texttt{*\_unittest.c} files, and look for differences with respect to a previous version of ESAIL.
